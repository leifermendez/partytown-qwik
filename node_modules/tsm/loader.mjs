import{existsSync as S,promises as j}from"fs";import{fileURLToPath as p,URL as g}from"url";import*as d from"./utils.js";let u,m,l=d.$defaults("esm"),x=l.file&&import("file:///"+l.file);async function y(){let t=await x;return t=t&&t.default||t,d.$finalize(l,t)}const h=/\.\w+(?=\?|$)/,w=/\.[mc]?tsx?(?=\?|$)/,T=/\.([mc])?js$/;async function f(t){u=u||await y();let[r]=h.exec(t)||[];return u[r]}function c(t){let r=p(t);if(S(r))return t}const b=new g("file:///"+process.cwd()+"/");export const resolve=async function(t,r,e){if(/^\w+\:?/.test(t))return e(t,r,e);let o,a,i,s,n=new g(t,r.parentURL||b);if(o=h.exec(n.href)){if(i=o[0],!r.parentURL||w.test(i))return{url:n.href,shortCircuit:!0};if(s=c(n.href),s)return{url:s,shortCircuit:!0};if(T.test(i)&&w.test(r.parentURL))return s=n.href.substring(0,a=o.index),(s=c(s+i.replace("js","ts")))?(a+=i.length,a>n.href.length&&(s+=n.href.substring(a)),{url:s,shortCircuit:!0}):e(t,r,e)}u=u||await y();for(i in u)if(s=c(n.href+i),s)return{url:s,shortCircuit:!0};return e(t,r,e)},load=async function(t,r,e){let o=await f(t);if(o==null)return e(t,r,e);let a=o.format==="cjs"?"commonjs":"module",i=p(t),s=await j.readFile(i);m=m||await import("esbuild");let n=await m.transform(s.toString(),{...o,sourcefile:i,format:a==="module"?"esm":"cjs"});return{format:a,source:n.code,shortCircuit:!0}},getFormat=async function(t,r,e){let o=await f(t);return o==null?e(t,r,e):{format:o.format==="cjs"?"commonjs":"module"}},transformSource=async function(t,r,e){let o=await f(r.url);return o==null?e(t,r,e):(m=m||await import("esbuild"),{source:(await m.transform(t.toString(),{...o,sourcefile:r.url,format:r.format==="module"?"esm":"cjs"})).code})};
